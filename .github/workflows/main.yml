name: CI/CD Pipeline

on:
  push:
    branches: [ "CICD" ] # 當推送到 CICD 分支時觸發

jobs:
  test:
    name: Run Pytest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create .env File
        run: |
          echo "POSTGRES_USER=user" > Backend/.env
          echo "POSTGRES_PASSWORD=password" >> Backend/.env
          echo "POSTGRES_DB=mydatabase" >> Backend/.env
          echo "DATABASE_URL=postgresql://\${POSTGRES_USER}:\${POSTGRES_PASSWORD}@db:5432/\${POSTGRES_DB}" >> Backend/.env
          echo "JWT_SECRET_KEY=123" >> Backend/.env
          echo "REGISTER_KEY=123" >> Backend/.env
          echo "ADMIN_ACCOUNT=user" >> Backend/.env
          echo "ADMIN_PASSWORD=test" >> Backend/.env
          echo "APP_URL=http://127.0.0.1:5000" >> Backend/.env
          echo "ADMIN=1" >> Backend/.env
          echo "GUEST=2" >> Backend/.env
          echo "GUEST_MODE=True" >> Backend/.env
          
      - name: Build > pytest
        run: |
          echo "Building and starting services..."
          make build
          
          sleep 50
          
          echo "Running Pytests..."
          make test
          
      - name: docker compose down
        if: always()
        run: |
          make down